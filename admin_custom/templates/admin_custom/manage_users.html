{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Users - Library Management System{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007bff, #6c757d);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .btn-loading .spinner-border {
        width: 1rem;
        height: 1rem;
    }
    .modal-xl {
        max-width: 90%;
    }
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    .invalid-feedback {
        font-size: 0.875rem;
    }
    #studentFields, #staffFields {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-people me-2"></i>Manage Users</h2>
            <p class="text-muted mb-0">Manage library users, their roles, and permissions</p>
        </div>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="bi bi-person-plus me-2"></i>Add New User
            </button>
            <button class="btn btn-info">
                <i class="bi bi-upload me-2"></i>Bulk Import
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_users }}</h4>
                            <p class="mb-0">Total Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ active_users }}</h4>
                            <p class="mb-0">Active Users</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-person-check fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ new_users_today }}</h4>
                            <p class="mb-0">New Today</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-person-plus fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ users_with_fines }}</h4>
                            <p class="mb-0">With Fines</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Search & Filters</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="searchUsers" class="form-label">Search Users</label>
                    <input type="text" class="form-control" id="searchUsers" name="q" 
                           value="{{ query }}" placeholder="Name, Email, Username...">
                </div>
                <div class="col-md-3">
                    <label for="userType" class="form-label">User Type</label>
                    <select class="form-select" id="userType" name="role">
                        <option value="">All Types</option>
                        <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
                        <option value="staff" {% if role_filter == 'staff' %}selected{% endif %}>Staff</option>
                        <option value="student" {% if role_filter == 'student' %}selected{% endif %}>Student</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">All Status</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-2"></i>Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Users ({{ page_obj.paginator.count }} total)</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2">
                    <i class="bi bi-download me-1"></i>Export
                </button>
                <button class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-gear me-1"></i>Settings
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" class="form-check-input"></th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th>Activity</th>
                            <th>Role Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in page_obj %}
                        <tr>
                            <td><input type="checkbox" class="form-check-input"></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-3">
                                        {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ user.get_full_name|default:user.username }}</div>
                                        <small class="text-muted">{{ user.username }}</small>
                                        
                                        <!-- FIXED ID DISPLAY LOGIC -->
                                        {% if user.is_superuser %}
                                            <!-- Admin users -->
                                            {% if user.staff_profile %}
                                                <br><small class="text-danger">Admin ID: {{ user.staff_profile.employee_id }}</small>
                                            {% else %}
                                                <br><small class="text-muted">No admin profile</small>
                                            {% endif %}
                                        {% elif user.is_staff %}
                                            <!-- Staff users (not admin) -->
                                            {% if user.staff_profile %}
                                                <br><small class="text-warning">Staff ID: {{ user.staff_profile.employee_id }}</small>
                                            {% else %}
                                                <br><small class="text-muted">No staff profile</small>
                                            {% endif %}
                                        {% else %}
                                            <!-- Student users -->
                                            {% if user.member_profile %}
                                                <br><small class="text-success">Student ID: {{ user.member_profile.member_id }}</small>
                                            {% else %}
                                                <br><small class="text-muted">No student profile</small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if user.is_superuser %}
                                    <span class="badge bg-danger">Admin</span>
                                {% elif user.is_staff %}
                                    <span class="badge bg-warning">Staff</span>
                                {% else %}
                                    <span class="badge bg-success">Student</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ user.email }}</div>
                                {% if user.profile and user.profile.phone_number %}
                                    <small class="text-muted">{{ user.profile.phone_number }}</small>
                                {% else %}
                                    <small class="text-muted">No phone</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.is_active %}
                                    <span class="badge bg-success status-badge">
                                        <i class="bi bi-check-circle me-1"></i>Active
                                    </span>
                                    <br><small class="text-success">Verified</small>
                                {% else %}
                                    <span class="badge bg-danger status-badge">
                                        <i class="bi bi-x-circle me-1"></i>Inactive
                                    </span>
                                    <br><small class="text-danger">Suspended</small>
                                {% endif %}
                            </td>
                            <td>
                                <div>Joined: {{ user.date_joined|date:"M d, Y" }}</div>
                                {% if user.last_login %}
                                    <small class="text-muted">Last: {{ user.last_login|timesince }} ago</small>
                                {% else %}
                                    <small class="text-muted">Never logged in</small>
                                {% endif %}
                            </td>                            <td>
                                {% if user.profile and user.profile.role == 'student' %}
                                    {% if user.member_profile %}
                                        <span class="badge bg-info">Active</span>
                                        <br><small class="text-muted">Books: {{ user.member_profile.current_borrowings_count }}/{{ user.member_profile.max_books }}</small>
                                    {% else %}
                                        <span class="badge bg-secondary">No Profile</span>
                                    {% endif %}
                                {% elif user.profile and user.profile.role == 'admin' %}
                                    <span class="badge bg-danger">Administrator</span>
                                    <br><small class="text-muted">System Admin</small>
                                {% elif user.profile and user.profile.role == 'staff' %}
                                    <span class="badge bg-warning">Staff Member</span>
                                    <br><small class="text-muted">Library Staff</small>
                                {% else %}
                                    <span class="badge bg-secondary">No Profile</span>
                                    <br><small class="text-muted">Profile missing</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" data-user-id="{{ user.id }}" onclick="viewUser(this.dataset.userId); return false;">
                                            <i class="bi bi-eye me-2"></i>View Details
                                        </a></li>                                        <li><a class="dropdown-item" href="#" data-user-id="{{ user.id }}" onclick="openEditModal(this.dataset.userId); return false;">
                                            <i class="bi bi-pencil me-2"></i>Edit
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        {% if user.is_active %}
                                            <li><a class="dropdown-item text-warning" href="#" data-user-id="{{ user.id }}" onclick="toggleUserStatus(this.dataset.userId); return false;">
                                                <i class="bi bi-pause me-2"></i>Deactivate
                                            </a></li>
                                        {% else %}
                                            <li><a class="dropdown-item text-success" href="#" data-user-id="{{ user.id }}" onclick="toggleUserStatus(this.dataset.userId); return false;">
                                                <i class="bi bi-play me-2"></i>Activate
                                            </a></li>
                                        {% endif %}
                                        <li><a class="dropdown-item text-danger" href="#" data-user-id="{{ user.id }}" onclick="deleteUser(this.dataset.userId); return false;">
                                            <i class="bi bi-trash me-2"></i>Delete
                                        </a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-people fs-1 text-muted"></i>
                                <p class="text-muted mt-2">No users found matching your criteria.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Users pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">&laquo; First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Last &raquo;</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- ADD USER MODAL -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add New User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm" method="post" action="{% url 'admin_custom:add_user' %}" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Basic User Information -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-fill me-2"></i>Basic Information
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="new_username" name="username" required>
                            <div class="invalid-feedback">Please enter a username.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="new_email" name="email" required>
                            <div class="invalid-feedback">Please enter a valid email.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_first_name" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="new_first_name" name="first_name" required>
                            <div class="invalid-feedback">Please enter first name.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_last_name" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="new_last_name" name="last_name" required>
                            <div class="invalid-feedback">Please enter last name.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_password" class="form-label">Password *</label>
                            <input type="password" class="form-control" id="new_password" name="password" required minlength="6">
                            <div class="invalid-feedback">Password must be at least 6 characters.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_confirm_password" class="form-label">Confirm Password *</label>
                            <input type="password" class="form-control" id="new_confirm_password" name="confirm_password" required>
                            <div class="invalid-feedback">Passwords must match.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="new_user_type" class="form-label">User Type *</label>
                            <select class="form-select" id="new_user_type" name="user_type" required onchange="toggleUserTypeFields()">
                                <option value="">Select Type</option>
                                <option value="student">Student</option>
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>
                            <div class="invalid-feedback">Please select a user type.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="new_is_active" name="is_active" checked>
                                <label class="form-check-label" for="new_is_active">
                                    Active account
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Student Specific Fields -->
                    <div id="studentFields" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-person-badge me-2"></i>Student Information
                                </h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_student_id" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="new_student_id" name="student_id" placeholder="Auto-generated if empty">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="new_phone" name="phone">
                            </div>                            <div class="col-md-4 mb-3">
                                <label for="new_age" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="new_age" name="age" min="16" max="100" 
                                       readonly style="background-color: #f8f9fa;" 
                                       placeholder="Auto-calculated from DOB">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="new_date_of_birth" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="new_date_of_birth" name="date_of_birth">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="new_gender" class="form-label">Gender *</label>
                                <select class="form-select" id="new_gender" name="gender">
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="new_address" class="form-label">Address</label>
                                <textarea class="form-control" id="new_address" name="address" rows="2" placeholder="Enter full address"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_max_books" class="form-label">Max Books Allowed</label>
                                <input type="number" class="form-control" id="new_max_books" name="max_books" min="1" max="10" value="3">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_max_reservations" class="form-label">Max Reservations Allowed</label>
                                <input type="number" class="form-control" id="new_max_reservations" name="max_reservations" min="1" max="5" value="2">
                            </div>
                        </div>
                    </div>                    <!-- Staff Specific Fields -->
                    <div id="staffFields" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 id="staffSectionTitle" class="text-warning mb-3">
                                    <i class="bi bi-briefcase me-2"></i>Staff Information
                                </h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_employee_id" class="form-label" id="employeeIdLabel">Employee ID</label>
                                <input type="text" class="form-control" id="new_employee_id" name="employee_id" placeholder="Auto-generated if empty">
                            </div><div class="col-md-6 mb-3">
                                <label for="new_staff_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="new_staff_phone" name="staff_phone">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="new_staff_age" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="new_staff_age" name="staff_age" min="18" max="70" 
                                       readonly style="background-color: #f8f9fa;" 
                                       placeholder="Auto-calculated from DOB">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="new_staff_dob" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="new_staff_dob" name="staff_date_of_birth">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="new_staff_gender" class="form-label">Gender *</label>
                                <select class="form-select" id="new_staff_gender" name="staff_gender">
                                    <option value="">Select Gender</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_department" class="form-label">Department *</label>
                                <input type="text" class="form-control" id="new_department" name="department" placeholder="e.g., Library Services">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_position" class="form-label">Position *</label>
                                <input type="text" class="form-control" id="new_position" name="position" placeholder="e.g., Librarian">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_hire_date" class="form-label">Hire Date *</label>
                                <input type="date" class="form-control" id="new_hire_date" name="hire_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="new_emergency_contact" class="form-label">Emergency Contact</label>
                                <input type="text" class="form-control" id="new_emergency_contact" name="emergency_contact" placeholder="Name and phone number">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="addUserBtn">
                        <span class="btn-text">
                            <i class="bi bi-person-plus me-2"></i>Add User
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            Adding...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- EDIT USER MODAL -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="bi bi-pencil me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" method="post" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Basic User Information -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-fill me-2"></i>Basic Information
                            </h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_username" class="form-label">Username *</label>
                            <input type="text" class="form-control" id="edit_username" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="edit_email" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_first_name" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_last_name" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="edit_password" name="password" minlength="6">
                            <div class="form-text">Leave blank to keep current password</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_user_type" class="form-label">User Type *</label>
                            <select class="form-select" id="edit_user_type" name="user_type" required onchange="toggleEditUserTypeFields()">
                                <option value="student">Student</option>
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                                <label class="form-check-label" for="edit_is_active">
                                    Active account
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Student Specific Fields -->
                    <div id="editStudentFields" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-success mb-3">
                                    <i class="bi bi-person-badge me-2"></i>Student Information
                                </h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_student_id" class="form-label">Student ID</label>
                                <input type="text" class="form-control" id="edit_student_id" name="student_id">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="edit_phone" name="phone">
                            </div>                            <div class="col-md-4 mb-3">
                                <label for="edit_age" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="edit_age" name="age" min="16" max="100" 
                                       readonly style="background-color: #f8f9fa;" 
                                       placeholder="Auto-calculated from DOB">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_date_of_birth" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="edit_date_of_birth" name="date_of_birth">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_gender" class="form-label">Gender *</label>
                                <select class="form-select" id="edit_gender" name="gender">
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="edit_address" class="form-label">Address</label>
                                <textarea class="form-control" id="edit_address" name="address" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_max_books" class="form-label">Max Books Allowed</label>
                                <input type="number" class="form-control" id="edit_max_books" name="max_books" min="1" max="10">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_max_reservations" class="form-label">Max Reservations Allowed</label>
                                <input type="number" class="form-control" id="edit_max_reservations" name="max_reservations" min="1" max="5">
                            </div>
                        </div>
                    </div>                    <!-- Staff Specific Fields -->
                    <div id="editStaffFields" style="display: none;">
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6 id="editStaffSectionTitle" class="text-warning mb-3">
                                    <i class="bi bi-briefcase me-2"></i>Staff Information
                                </h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_employee_id" class="form-label" id="editEmployeeIdLabel">Employee ID</label>
                                <input type="text" class="form-control" id="edit_employee_id" name="employee_id">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_staff_phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="edit_staff_phone" name="staff_phone">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_staff_age" class="form-label">Age *</label>
                                <input type="number" class="form-control" id="edit_staff_age" name="staff_age" min="18" max="70" 
                                       readonly style="background-color: #f8f9fa;" 
                                       placeholder="Auto-calculated from DOB">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_staff_dob" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="edit_staff_dob" name="staff_date_of_birth">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit_staff_gender" class="form-label">Gender *</label>
                                <select class="form-select" id="edit_staff_gender" name="staff_gender">
                                    <option value="">Select Gender</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                    <option value="O">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_department" class="form-label">Department *</label>
                                <input type="text" class="form-control" id="edit_department" name="department">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_position" class="form-label">Position *</label>
                                <input type="text" class="form-control" id="edit_position" name="position">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_hire_date" class="form-label">Hire Date *</label>
                                <input type="date" class="form-control" id="edit_hire_date" name="hire_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit_emergency_contact" class="form-label">Emergency Contact</label>
                                <input type="text" class="form-control" id="edit_emergency_contact" name="emergency_contact">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'admin_custom/partials/user_detail_modal.html' %}
{% include 'admin_custom/partials/password_reset_modal.html' %}
{% include 'admin_custom/partials/delete_user_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
// Toggle fields based on user type selection
function toggleUserTypeFields() {
    const userType = document.getElementById('new_user_type').value;
    const studentFields = document.getElementById('studentFields');
    const staffFields = document.getElementById('staffFields');
    
    // Hide all fields first
    studentFields.style.display = 'none';
    staffFields.style.display = 'none';
    
    // Clear required attributes
    clearRequiredFields();
    
    // Show relevant fields based on selection
    if (userType === 'student') {
        studentFields.style.display = 'block';
        setStudentFieldsRequired();
        setDefaultDateOfBirth();    } else if (userType === 'staff' || userType === 'admin') {
        staffFields.style.display = 'block';
        setStaffFieldsRequired();
        setDefaultHireDate();
        
        // Get the elements to update
        const staffSectionTitle = document.getElementById('staffSectionTitle');
        const employeeIdLabel = document.getElementById('employeeIdLabel');
        
        // Set default values and update text/color based on user type
        if (userType === 'admin') {
            document.getElementById('new_department').value = 'Administration';
            document.getElementById('new_position').value = 'Administrator';
            
            // Update for Admin
            staffSectionTitle.className = 'text-danger mb-3'; // Red color
            staffSectionTitle.innerHTML = '<i class="bi bi-shield-check me-2"></i>Admin Information';
            employeeIdLabel.textContent = 'Admin ID';
        } else {
            document.getElementById('new_department').value = '';
            document.getElementById('new_position').value = '';
            
            // Update for Staff
            staffSectionTitle.className = 'text-warning mb-3'; // Yellow color
            staffSectionTitle.innerHTML = '<i class="bi bi-briefcase me-2"></i>Staff Information';
            employeeIdLabel.textContent = 'Employee ID';
        }
    }
}

function clearRequiredFields() {
    const conditionalFields = [
        'new_age', 'new_date_of_birth', 'new_gender',
        'new_department', 'new_position', 'new_hire_date',
        'new_staff_age', 'new_staff_dob', 'new_staff_gender'
    ];
    
    conditionalFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.required = false;
            field.classList.remove('is-invalid');
        }
    });
}

function setStudentFieldsRequired() {
    const requiredFields = ['new_age', 'new_date_of_birth', 'new_gender'];
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.required = true;
    });
}

function setStaffFieldsRequired() {
    const requiredFields = [
        'new_department', 'new_position', 'new_hire_date',
        'new_staff_age', 'new_staff_dob', 'new_staff_gender'
    ];
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.required = true;
    });
}

function setDefaultDateOfBirth() {
    const dobField = document.getElementById('new_date_of_birth');
    if (dobField && !dobField.value) {
        const eighteenYearsAgo = new Date();
        eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);
        dobField.value = eighteenYearsAgo.toISOString().split('T')[0];
    }
}

function setDefaultHireDate() {
    const hireDateField = document.getElementById('new_hire_date');
    if (hireDateField && !hireDateField.value) {
        const today = new Date();
        hireDateField.value = today.toISOString().split('T')[0];
    }
}

function initializeAddUserForm() {
    const addUserForm = document.getElementById('addUserForm');
    if (!addUserForm) return;
    
    const passwordField = document.getElementById('new_password');
    const confirmPasswordField = document.getElementById('new_confirm_password');
    
    if (confirmPasswordField) {
        confirmPasswordField.addEventListener('input', function() {
            if (passwordField.value !== confirmPasswordField.value) {
                confirmPasswordField.setCustomValidity('Passwords do not match');
                confirmPasswordField.classList.add('is-invalid');
            } else {
                confirmPasswordField.setCustomValidity('');
                confirmPasswordField.classList.remove('is-invalid');
            }
        });
    }
    
    addUserForm.addEventListener('submit', function(event) {
        const userType = document.getElementById('new_user_type').value;
        
        if (userType === 'student') {
            const age = document.getElementById('new_age').value;
            const dob = document.getElementById('new_date_of_birth').value;
            const gender = document.getElementById('new_gender').value;
            
            if (!age || !dob || !gender) {
                event.preventDefault();
                alert('Please fill in all required student fields (Age, Date of Birth, and Gender)');
                return false;
            }        } else if (userType === 'staff' || userType === 'admin') {
            const department = document.getElementById('new_department').value;
            const position = document.getElementById('new_position').value;
            const hireDate = document.getElementById('new_hire_date').value;
            const staffAge = document.getElementById('new_staff_age').value;
            const staffDob = document.getElementById('new_staff_dob').value;
            const staffGender = document.getElementById('new_staff_gender').value;
            
            if (!department || !position || !hireDate) {
                event.preventDefault();
                alert('Please fill in all required staff fields (Department, Position, and Hire Date)');
                return false;
            }
            
            if (!staffAge || !staffDob || !staffGender) {
                event.preventDefault();
                alert('Please fill in all required personal information (Age, Date of Birth, and Gender)');
                return false;
            }
        }
        
        const addUserBtn = document.getElementById('addUserBtn');
        const btnText = addUserBtn.querySelector('.btn-text');
        const btnLoading = addUserBtn.querySelector('.btn-loading');
        
        addUserBtn.disabled = true;
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        
        return true;    });
}

// Age calculation functionality for both add and edit modals
function initializeAgeCalculation() {
    // For Add User Modal - Student fields
    const newDobField = document.getElementById('new_date_of_birth');
    const newAgeField = document.getElementById('new_age');
    
    if (newDobField && newAgeField) {
        newDobField.addEventListener('change', function() {
            calculateAndSetAge(this.value, newAgeField, 16, 100);
        });
    }
    
    // For Add User Modal - Staff fields
    const newStaffDobField = document.getElementById('new_staff_dob');
    const newStaffAgeField = document.getElementById('new_staff_age');
    
    if (newStaffDobField && newStaffAgeField) {
        newStaffDobField.addEventListener('change', function() {
            calculateAndSetAge(this.value, newStaffAgeField, 18, 70);
        });
    }
    
    // For Edit User Modal - Student fields
    const editDobField = document.getElementById('edit_date_of_birth');
    const editAgeField = document.getElementById('edit_age');
    
    if (editDobField && editAgeField) {
        editDobField.addEventListener('change', function() {
            calculateAndSetAge(this.value, editAgeField, 16, 100);
        });
    }
    
    // For Edit User Modal - Staff fields
    const editStaffDobField = document.getElementById('edit_staff_dob');
    const editStaffAgeField = document.getElementById('edit_staff_age');
    
    if (editStaffDobField && editStaffAgeField) {
        editStaffDobField.addEventListener('change', function() {
            calculateAndSetAge(this.value, editStaffAgeField, 18, 70);
        });
    }
}

function calculateAndSetAge(dobValue, ageField, minAge = 16, maxAge = 100) {
    if (!dobValue || !ageField) return;
    
    const dob = new Date(dobValue);
    const today = new Date();
    
    if (dob && dob <= today) {
        let age = today.getFullYear() - dob.getFullYear();
        const monthDiff = today.getMonth() - dob.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
            age--;
        }
        
        if (age >= minAge && age <= maxAge) {
            ageField.value = age;
            ageField.classList.remove('is-invalid');
        } else {
            ageField.value = '';
            if (age < minAge) {
                alert(`Age must be at least ${minAge} years old.`);
            } else if (age > maxAge) {
                alert('Please check the date of birth.');
            }
            ageField.classList.add('is-invalid');
        }
    } else {
        ageField.value = '';
    }
}

document.getElementById('addUserModal').addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('addUserForm');
    const userType = document.getElementById('new_user_type');
    
    form.reset();
    form.classList.remove('was-validated');
    userType.value = '';
    toggleUserTypeFields();
    
    const addUserBtn = document.getElementById('addUserBtn');
    const btnText = addUserBtn.querySelector('.btn-text');
    const btnLoading = addUserBtn.querySelector('.btn-loading');
    
    addUserBtn.disabled = false;
    btnText.classList.remove('d-none');
    btnLoading.classList.add('d-none');
});

document.addEventListener('DOMContentLoaded', function() {
    initializeAddUserForm();
    initializeEditUserForm();
    initializeAgeCalculation(); // ✅ ADD age calculation
    initializePasswordResetModal();
    initializeDeleteModal();
    initializeUserDetailModal();
});

function openEditModal(userId) {
    console.log('Opening edit modal for user ID:', userId);
    
    // First, fetch user data
    fetch(`/portal/users/${userId}/view/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const user = data.user;
            
            // Populate basic user information
            document.getElementById('edit_username').value = user.username || '';
            document.getElementById('edit_email').value = user.email || '';
            document.getElementById('edit_first_name').value = user.first_name || '';
            document.getElementById('edit_last_name').value = user.last_name || '';
            document.getElementById('edit_is_active').checked = user.is_active || false;
            
            // Set user type and toggle fields
            const userTypeField = document.getElementById('edit_user_type');
            userTypeField.value = user.user_type.toLowerCase();
            toggleEditUserTypeFields();
            
            // Populate user-type specific fields
            if (user.user_type === 'student') {
                // Populate student fields
                document.getElementById('edit_student_id').value = user.student_id || '';
                document.getElementById('edit_phone').value = user.phone || '';
                document.getElementById('edit_age').value = user.age || '';
                document.getElementById('edit_date_of_birth').value = user.date_of_birth || '';
                document.getElementById('edit_gender').value = user.gender || '';
                document.getElementById('edit_address').value = user.address || '';
                document.getElementById('edit_max_books').value = user.max_books || '';
                document.getElementById('edit_max_reservations').value = user.max_reservations || '';
            } else if (user.user_type === 'staff' || user.user_type === 'admin') {
                // Populate staff/admin fields
                document.getElementById('edit_employee_id').value = user.employee_id || '';
                document.getElementById('edit_staff_phone').value = user.staff_phone || '';
                document.getElementById('edit_staff_age').value = user.staff_age || '';
                document.getElementById('edit_staff_dob').value = user.staff_date_of_birth || '';
                document.getElementById('edit_staff_gender').value = user.staff_gender || '';
                document.getElementById('edit_department').value = user.department || '';
                document.getElementById('edit_position').value = user.position || '';
                document.getElementById('edit_hire_date').value = user.hire_date || '';
                document.getElementById('edit_emergency_contact').value = user.emergency_contact || '';
            }
            
            // Set the form action URL for submission
            const editForm = document.getElementById('editUserForm');
            editForm.action = `/portal/users/${userId}/update/`;
            
            // Store user ID in a hidden field or data attribute
            editForm.dataset.userId = userId;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            editModal.show();
            
        } else {
            alert('Error loading user data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to load user data: ' + error.message);
    });
}

function initializeEditUserForm() {
    const editUserForm = document.getElementById('editUserForm');
    if (!editUserForm) return;
    
    editUserForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const userId = editUserForm.dataset.userId;
        const formData = new FormData(editUserForm);
        
        // Show loading state
        const submitBtn = editUserForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        submitBtn.disabled = true;
        
        fetch(`/portal/users/${userId}/update/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('User updated successfully!');
                
                // Close modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                editModal.hide();
                
                // Reload page to show updated data
                location.reload();
            } else {
                alert('Error updating user: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update user: ' + error.message);
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
}

function populateEditModal(user) {
    document.getElementById('edit_username').value = user.username || '';
    document.getElementById('edit_email').value = user.email || '';
    document.getElementById('edit_first_name').value = user.first_name || '';
    document.getElementById('edit_last_name').value = user.last_name || '';
    document.getElementById('edit_user_type').value = user.user_type || '';
    document.getElementById('edit_is_active').checked = user.is_active || false;
    
    toggleEditUserTypeFields();
}

function toggleEditUserTypeFields() {
    const userType = document.getElementById('edit_user_type').value;
    const studentFields = document.getElementById('editStudentFields');
    const staffFields = document.getElementById('editStaffFields');
    
    studentFields.style.display = 'none';
    staffFields.style.display = 'none';
    
    if (userType === 'student') {
        studentFields.style.display = 'block';
    } else if (userType === 'staff' || userType === 'admin') {
        staffFields.style.display = 'block';
        
        // Get the elements to update
        const editStaffSectionTitle = document.getElementById('editStaffSectionTitle');
        const editEmployeeIdLabel = document.getElementById('editEmployeeIdLabel');
        
        // Set appropriate text and color based on user type
        if (userType === 'admin') {
            // Update for Admin
            editStaffSectionTitle.className = 'text-danger mb-3'; // Red color
            editStaffSectionTitle.innerHTML = '<i class="bi bi-shield-check me-2"></i>Admin Information';
            editEmployeeIdLabel.textContent = 'Admin ID';
        } else {
            // Update for Staff
            editStaffSectionTitle.className = 'text-warning mb-3'; // Yellow color
            editStaffSectionTitle.innerHTML = '<i class="bi bi-briefcase me-2"></i>Staff Information';
            editEmployeeIdLabel.textContent = 'Employee ID';
        }
    }
}

function viewUser(userId) {
    console.log('Loading user details for ID:', userId);
    
    fetch(`/portal/users/${userId}/view/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            populateUserDetailModal(data.user);
            const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
            modal.show();
        } else {
            showToast('Error loading user details: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to load user details: ' + error.message, 'error');
    });
}

function populateUserDetailModal(user) {
    // Basic Information - using correct element IDs from the modal template
    document.getElementById('detail_username').textContent = user.username;
    document.getElementById('detail_full_name').textContent = `${user.first_name} ${user.last_name}`.trim() || user.username;
    document.getElementById('detail_email').textContent = user.email;
    
    // User type badge
    const userTypeBadge = document.getElementById('detail_user_type');
    userTypeBadge.textContent = user.user_type ? user.user_type.charAt(0).toUpperCase() + user.user_type.slice(1) : 'Unknown';
    userTypeBadge.className = `badge ${getUserTypeBadgeClass(user.user_type)}`;
    
    // Status badge
    const statusBadge = document.getElementById('detail_status');
    statusBadge.textContent = user.is_active ? 'Active' : 'Inactive';
    statusBadge.className = `badge ${user.is_active ? 'bg-success' : 'bg-danger'}`;
    
    // Account Information
    document.getElementById('detail_date_joined').textContent = new Date(user.date_joined).toLocaleDateString();
    document.getElementById('detail_last_login').textContent = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
    
    // Staff status badge
    const staffStatusBadge = document.getElementById('detail_staff_status');
    staffStatusBadge.textContent = user.is_staff ? 'Yes' : 'No';
    staffStatusBadge.className = `badge ${user.is_staff ? 'bg-info' : 'bg-secondary'}`;
    
    // Superuser status badge
    const superuserBadge = document.getElementById('detail_superuser_status');
    superuserBadge.textContent = user.is_superuser ? 'Yes' : 'No';
    superuserBadge.className = `badge ${user.is_superuser ? 'bg-danger' : 'bg-secondary'}`;
    
    // Store user ID for the edit button
    document.getElementById('editUserFromDetail').dataset.userId = user.id;
}

function getUserTypeBadgeClass(userType) {
    switch(userType.toLowerCase()) {
        case 'admin':
            return 'bg-danger';
        case 'staff':
            return 'bg-warning text-dark';
        case 'student':
            return 'bg-primary';
        default:
            return 'bg-secondary';
    }
}

function showToast(message, type = 'success') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger';
    const headerText = type === 'success' ? 'Success' : 'Error';
    
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi ${iconClass} me-2"></i>
                <strong class="me-auto">${headerText}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 5000
    });
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
    
    toast.show();
}

function toggleUserStatus(userId) {
    console.log('Attempting to toggle status for user:', userId);
    
    fetch(`/portal/users/${userId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Reload page after a short delay to show the toast
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to toggle user status: ' + error.message, 'error');
    });
}

function resetPassword(userId) {
    console.log('Opening password reset modal for user ID:', userId);
    
    // First fetch user data to populate the modal
    fetch(`/portal/users/${userId}/view/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const user = data.user;
            
            // Populate modal with user info
            document.getElementById('reset_username').textContent = user.username;
            document.getElementById('reset_email').textContent = user.email;
            
            // Reset modal state
            document.getElementById('confirmReset').checked = false;
            document.getElementById('confirmPasswordReset').disabled = true;
            document.getElementById('newPasswordAlert').classList.add('d-none');
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
            modal.show();
            
            // Store user ID for later use
            document.getElementById('passwordResetModal').dataset.userId = userId;
            
        } else {
            showToast('Error loading user data: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to load user data: ' + error.message, 'error');
    });
}

function deleteUser(userId) {
    console.log('Opening delete modal for user ID:', userId);
    
    // First fetch user data to populate the modal
    fetch(`/portal/users/${userId}/view/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const user = data.user;
            
            // Populate modal with user info
            document.getElementById('delete_username').textContent = `${user.first_name} ${user.last_name} (${user.username})`;
            document.getElementById('delete_email').textContent = user.email;
            
            // Reset modal state
            document.getElementById('deleteConfirmText').value = '';
            document.getElementById('confirmDelete').checked = false;
            document.getElementById('confirmDeleteUser').disabled = true;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            modal.show();
            
            // Store user ID for later use
            document.getElementById('deleteUserModal').dataset.userId = userId;
            
        } else {
            showToast('Error loading user data: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to load user data: ' + error.message, 'error');    });
}

function initializePasswordResetModal() {
    // Enable/disable reset button based on checkbox
    const confirmCheckbox = document.getElementById('confirmReset');
    const resetButton = document.getElementById('confirmPasswordReset');
    
    if (confirmCheckbox && resetButton) {
        confirmCheckbox.addEventListener('change', function() {
            resetButton.disabled = !this.checked;
        });
    }
    
    // Handle password reset confirmation
    if (resetButton) {
        resetButton.addEventListener('click', function() {
            const userId = document.getElementById('passwordResetModal').dataset.userId;
            if (!userId) {
                showToast('Error: No user selected', 'error');
                return;
            }
            
            // Show loading state
            const btnText = this.querySelector('.btn-text');
            const btnLoading = this.querySelector('.btn-loading');
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            this.disabled = true;
            
            // Make the reset request
            fetch(`/portal/users/${userId}/reset-password/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show the new password
                    document.getElementById('newPasswordDisplay').value = data.new_password;
                    document.getElementById('reset_success_username').textContent = data.username;
                    document.getElementById('newPasswordAlert').classList.remove('d-none');
                    
                    // Hide the reset button and show success
                    this.style.display = 'none';
                    showToast('Password reset successfully!', 'success');
                } else {
                    showToast('Error resetting password: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to reset password: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset loading state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                this.disabled = false;
            });
        });
    }
    
    // Handle copy password button
    const copyButton = document.getElementById('copyPasswordBtn');
    if (copyButton) {
        copyButton.addEventListener('click', function() {
            const passwordField = document.getElementById('newPasswordDisplay');
            passwordField.select();
            passwordField.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                this.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
                showToast('Password copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy password', 'error');
            }        });
    }
}

function initializeDeleteModal() {
    // Enable/disable delete button based on text input and checkbox
    const confirmText = document.getElementById('deleteConfirmText');
    const confirmCheckbox = document.getElementById('confirmDelete');
    const deleteButton = document.getElementById('confirmDeleteUser');
    
    function updateDeleteButton() {
        if (confirmText && confirmCheckbox && deleteButton) {
            const textMatches = confirmText.value.toLowerCase() === 'delete';
            const checkboxChecked = confirmCheckbox.checked;
            deleteButton.disabled = !(textMatches && checkboxChecked);
        }
    }
    
    if (confirmText) {
        confirmText.addEventListener('input', updateDeleteButton);
    }
    
    if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', updateDeleteButton);
    }
    
    // Handle delete confirmation
    if (deleteButton) {
        deleteButton.addEventListener('click', function() {
            const userId = document.getElementById('deleteUserModal').dataset.userId;
            if (!userId) {
                showToast('Error: No user selected', 'error');
                return;
            }
            
            // Show loading state
            const btnText = this.querySelector('.btn-text');
            const btnLoading = this.querySelector('.btn-loading');
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            this.disabled = true;
            
            // Make the delete request
            fetch(`/portal/users/${userId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('User deleted successfully!', 'success');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                    modal.hide();
                    // Reload page to update the user list
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showToast('Error deleting user: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to delete user: ' + error.message, 'error');
            })
            .finally(() => {
                // Reset loading state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                this.disabled = false;
            });        });
    }
}

function initializeUserDetailModal() {
    // Handle edit button click from user detail modal
    const editButton = document.getElementById('editUserFromDetail');
    if (editButton) {
        editButton.addEventListener('click', function() {
            const userId = this.dataset.userId;
            if (userId) {
                // Close the detail modal first
                const detailModal = bootstrap.Modal.getInstance(document.getElementById('userDetailModal'));
                if (detailModal) {
                    detailModal.hide();
                }
                
                // Open the edit modal
                setTimeout(() => {
                    openEditModal(userId);
                }, 300);
            }
        });
    }
}
</script>
{% endblock %}